/**
 * Diccionario que define, para cada categoría, qué campos (columnas) deben ocultarse en la tabla.
 * La clave es el nombre de la categoría y el valor es un array con los nombres de los campos a ocultar.
 */
columnasOcultasPorCategoria = {
  BLUSAS: [
    "DISENO",
    "PUNO",
    "CAPOTA",
    "TIRO",
    "BOTA",
    "CINTURA",
    "SILUETA",
    "CIERRE",
    "GALGA",
    "TIPO_GALGA",
    "FORRO",
    "%_FORRO_1",
    "%_FORRO_2",
    "TOT_FORRO",
    "COMP_FORRO_1",
    "COMP_FORRO_2",
    "RELLENO",
    "%_RELLENO_1",
    "%_RELLENO_2",
    "TOT_RELLENO",
    "COMP_RELLENO_1",
    "COMP_RELLENO_2",
  ],
  CAMISAS: [
    "DISENO",
    "TIPO_MANGA",
    "PUNO",
    "CAPOTA",
    "ESCOTE",
    "CUELLO",
    "TIRO",
    "BOTA",
    "CINTURA",
    "SILUETA",
    "CIERRE",
    "GALGA",
    "TIPO_GALGA",
    "FORRO",
    "%_FORRO_1",
    "%_FORRO_2",
    "TOT_FORRO",
    "COMP_FORRO_1",
    "COMP_FORRO_2",
    "RELLENO",
    "%_RELLENO_1",
    "%_RELLENO_2",
    "TOT_RELLENO",
    "COMP_RELLENO_1",
    "COMP_RELLENO_2",
  ],
  CAMISETAS: [
    "DISENO",
    "CAPOTA",
    "TIRO",
    "BOTA",
    "CINTURA",
    "SILUETA",
    "CIERRE",
    "GALGA",
    "TIPO_GALGA",
    "FORRO",
    "%_FORRO_1",
    "%_FORRO_2",
    "TOT_FORRO",
    "COMP_FORRO_1",
    "COMP_FORRO_2",
    "RELLENO",
    "%_RELLENO_1",
    "%_RELLENO_2",
    "TOT_RELLENO",
    "COMP_RELLENO_1",
    "COMP_RELLENO_2",
  ],
  PUNTO: [
    "DISENO",
    "PUNO",
    "ESCOTE",
    "TIRO",
    "BOTA",
    "CINTURA",
    "SILUETA",
    "CIERRE",
    "FORRO",
    "%_FORRO_1",
    "%_FORRO_2",
    "TOT_FORRO",
    "COMP_FORRO_1",
    "COMP_FORRO_2",
    "RELLENO",
    "%_RELLENO_1",
    "%_RELLENO_2",
    "TOT_RELLENO",
    "COMP_RELLENO_1",
    "COMP_RELLENO_2",
  ],
  FELPA: [
    "DISENO",
    "TIPO_MANGA",
    "PUNO",
    "ESCOTE",
    "LARGO",
    "CUELLO",
    "TIRO",
    "BOTA",
    "CINTURA",
    "SILUETA",
    "CIERRE",
    "GALGA",
    "TIPO_GALGA",
    "FORRO",
    "%_FORRO_1",
    "%_FORRO_2",
    "TOT_FORRO",
    "COMP_FORRO_1",
    "COMP_FORRO_2",
    "RELLENO",
    "%_RELLENO_1",
    "%_RELLENO_2",
    "TOT_RELLENO",
    "COMP_RELLENO_1",
    "COMP_RELLENO_2",
  ],
  CHAQUETAS: [
    "TIPO_MANGA",
    "PUNO",
    "ESCOTE",
    "TIRO",
    "BOTA",
    "CINTURA",
    "SILUETA",
    "GALGA",
    "TIPO_GALGA",
  ],
  VESTIDOS: [
    "DISENO",
    "PUNO",
    "CAPOTA",
    "LARGO",
    "CUELLO",
    "TIRO",
    "BOTA",
    "CINTURA",
    "CIERRE",
    "GALGA",
    "TIPO_GALGA",
    "FORRO",
    "%_FORRO_1",
    "%_FORRO_2",
    "TOT_FORRO",
    "COMP_FORRO_1",
    "COMP_FORRO_2",
    "RELLENO",
    "%_RELLENO_1",
    "%_RELLENO_2",
    "TOT_RELLENO",
    "COMP_RELLENO_1",
    "COMP_RELLENO_2",
  ],
  FALDAS: [
    "MANGA",
    "TIPO_MANGA",
    "PUNO",
    "CAPOTA",
    "ESCOTE",
    "LARGO",
    "CUELLO",
    "TIRO",
    "BOTA",
    "SILUETA",
    "CIERRE",
    "GALGA",
    "TIPO_GALGA",
    "RELLENO",
    "%_RELLENO_1",
    "%_RELLENO_2",
    "TOT_RELLENO",
    "COMP_RELLENO_1",
    "COMP_RELLENO_2",
  ],
  JEANS: [
    "MANGA",
    "TIPO_MANGA",
    "PUNO",
    "CAPOTA",
    "ESCOTE",
    "LARGO",
    "CUELLO",
    "CINTURA",
    "SILUETA",
    "CIERRE",
    "GALGA",
    "TIPO_GALGA",
    "FORRO",
    "%_FORRO_1",
    "%_FORRO_2",
    "TOT_FORRO",
    "COMP_FORRO_1",
    "COMP_FORRO_2",
    "RELLENO",
    "%_RELLENO_1",
    "%_RELLENO_2",
    "TOT_RELLENO",
    "COMP_RELLENO_1",
    "COMP_RELLENO_2",
  ],
  PANTALONES: [
    "DISENO",
    "MANGA",
    "TIPO_MANGA",
    "PUNO",
    "CAPOTA",
    "ESCOTE",
    "LARGO",
    "CUELLO",
    "CINTURA",
    "SILUETA",
    "CIERRE",
    "GALGA",
    "TIPO_GALGA",
    "FORRO",
    "%_FORRO_1",
    "%_FORRO_2",
    "TOT_FORRO",
    "COMP_FORRO_1",
    "COMP_FORRO_2",
    "RELLENO",
    "%_RELLENO_1",
    "%_RELLENO_2",
    "TOT_RELLENO",
    "COMP_RELLENO_1",
    "COMP_RELLENO_2",
  ],
};

/**
 * Muestra todas las columnas de la tabla, tanto encabezados (th) como celdas (td).
 * Esto es útil para "resetear" la tabla antes de ocultar columnas específicas.
 */
function mostrarTodasLasColumnas() {
  // Mostrar todos los encabezados de columna (th)
  document.querySelectorAll("#skuTable thead th").forEach((th) => {
    th.style.display = "";
  });
  // Mostrar todas las celdas de cada fila (td)
  document.querySelectorAll("#skuTable tbody tr").forEach((tr) => {
    tr.querySelectorAll("td").forEach((td) => {
      td.style.display = "";
    });
  });
}

/**
 * Devuelve un objeto que mapea el nombre del campo (data-campo-nombre) al índice de la columna.
 * Esto facilita encontrar la posición de cada campo en la tabla.
 */
function obtenerIndicesColumnasPorCampo() {
  const indices = {};
  document.querySelectorAll("#skuTable thead th").forEach((th, idx) => {
    const campo = th.getAttribute("data-campo-nombre");
    if (campo) indices[campo] = idx;
  });
  return indices;
}

/**
 * Oculta columnas completas según la categoría seleccionada.
 * @param {string} categoria - Nombre de la categoría seleccionada.
 */
function actualizarColumnasPorCategoria(categoria) {
  // Primero, muestra todas las columnas para limpiar cualquier ocultamiento previo.
  mostrarTodasLasColumnas();

  // Obtiene la lista de campos a ocultar para la categoría seleccionada.
  const camposOcultar = columnasOcultasPorCategoria[categoria];
  if (!camposOcultar) return; // Si no hay configuración para la categoría, no hace nada.

  // Recorre todos los encabezados de columna (th)
  document.querySelectorAll("#skuTable thead th").forEach((th, idx) => {
    const campo = th.getAttribute("data-campo-nombre");
    // Si el campo está en la lista de ocultar, oculta el th y todos los td de esa columna.
    if (campo && camposOcultar.includes(campo)) {
      th.style.display = "none";
      // Oculta la celda correspondiente en cada fila del cuerpo de la tabla.
      document.querySelectorAll(`#skuTable tbody tr`).forEach((tr) => {
        const td = tr.querySelector(`td:nth-child(${idx + 1})`);
        if (td) td.style.display = "none";
      });
    }
  });
}

// --- Hook principal: se ejecuta cuando el DOM está listo ---
document.addEventListener("DOMContentLoaded", () => {
  /**
   * Asigna el atributo data-campo-nombre a cada th si no lo tiene,
   * usando la información de la primera fila del tbody.
   * Esto permite mapear fácilmente los encabezados con los campos de datos.
   */
  document.querySelectorAll("#skuTable thead th").forEach((th, idx) => {
    if (!th.hasAttribute("data-campo-nombre")) {
      // Busca el primer td de la columna correspondiente en la primera fila
      const td = document.querySelector(
        `#skuTable tbody tr td:nth-child(${idx + 1})`
      );
      // Si el td tiene la clase y el atributo de campo, lo asigna al th
      if (
        td &&
        td.classList.contains("campo-formulario") &&
        td.dataset.campoNombre
      ) {
        th.setAttribute("data-campo-nombre", td.dataset.campoNombre);
      }
    }
  });

  /**
   * Escucha cambios en cualquier select de categoría dentro de la tabla.
   * Cuando se detecta un cambio, actualiza las columnas visibles según la nueva categoría seleccionada.
   */
  document.querySelector("#skuTable").addEventListener("change", function (e) {
    if (
      e.target.classList.contains("campo-formulario") &&
      e.target.dataset.campoNombre === "CATEGORIAS"
    ) {
      actualizarColumnasPorCategoria(e.target.value);
    }
  });

  /**
   * Opcional: al cargar la página, ajusta las columnas visibles según la categoría de la primera fila.
   * Esto asegura que la tabla se muestre correctamente desde el inicio.
   */
  const primeraCategoria = document.querySelector(
    '#skuTable tbody tr .campo-formulario[data-campo-nombre="CATEGORIAS"]'
  );
  if (primeraCategoria) {
    actualizarColumnasPorCategoria(primeraCategoria.value);
  }
});
